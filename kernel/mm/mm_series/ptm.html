<!DOCTYPE html>
<html lang="cn">
<head>
<!-- 2021-01-29 Fri 20:30 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>内存管理之页表管理</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Cauchy(pqy7172@gmail.com)">
<link rel="stylesheet" href="../../../org-manual.css" type="text/css">
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">内存管理之页表管理</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org53c49fc">1. 页目录表示</a></li>
</ul>
</div>
</div>
<p>
本文讲述Linux的页表管理, 在它的上一篇讲述了mm模块<a href="./des-phy-mem.html">如何描述物理内存</a>.
</p>

<p>
本文会讲述Linux内核的页表是如何组织的, 以及各级页表都使用什么类型的数据结构来描述. 接着会讲述一个虚拟地址是怎样划分为几部分从而用来一级一级的往下寻找页表, 最后会到PTE(Page Table
Entry). 还会介绍一些宏用来查找页表. 对启动阶段的页表初始化也会作出阐述, 最后就是TLB和CPU的Cache也会被讲述到.
</p>

<div id="outline-container-org53c49fc" class="outline-2">
<h2 id="org53c49fc"><span class="section-number-2">1</span> 页目录表示</h2>
<div class="outline-text-2" id="text-1">
<p>
每一个进程都有一个指针指向它自己PGD的指针(mm_struct-&gt;pgd), 这实际是一个页框, 这个页框包含一个pgd_t类型的数组. 这个成员是架构相关的定义, 在asm/page.h中, 比如ia64中是这样定义的:
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #F0DFAF; font-weight: bold;">typedef</span> <span style="color: #F0DFAF; font-weight: bold;">struct</span> { <span style="color: #7CB8BB;">unsigned</span> <span style="color: #7CB8BB;">long</span> <span style="color: #DFAF8F;">pgd</span>; } <span style="color: #7CB8BB;">pgd_t</span>;
</pre>
</div>

<p>
根据架构的不同，页表如何被加载也是不同的。以x86为例，进程页表的加载是通过将mm_struct-&gt;pgd复制到cr3寄存器中，同时会刷新tlb。
</p>

<p>
每一个pgd页表里的条目指向包含有许多pmd条目的页框基地址，pgd页表本身的基地址如前所述在x86下是将mm_struct-&gt;pgd拷贝到cr3寄存器中，而每一个pmd条目又指向包含有许多pte条目的页框基地址，
pte条目最终指向包含有用户所请求数据的页框基地址。如果是遇到page被swap out的情况，就会调用do_swap_page函数。页表组织如下图：
</p>


<div class="figure">
<p><img src="./img/page_layout.png" alt="page_layout.png" width="50%" height="50%" align="centering">
</p>
<p><span class="figure-number">Figure 1: </span>各级页表的组织</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Cauchy(pqy7172@gmail.com)</p>
<p class="date">Created: 2021-01-29 Fri 20:30</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
