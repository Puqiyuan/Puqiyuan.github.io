<!DOCTYPE html>
<html lang="cn">
<head>
<!-- 2019-03-12 Tue 15:42 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>协程切换实现</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Cauchy">
<link rel="stylesheet" href="https://cs3.swfu.edu.cn/~puqiyuan/org-manual.css" type="text/css">
<style>code {font-family:Monospace; font-size:90%; background-color: #eee} body {font-size:14pt}</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">协程切换实现</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org8a16955">1. 协程概念</a></li>
<li><a href="#orga5b9f46">2. 架构介绍</a>
<ul>
<li><a href="#org7088211">2.1. X86</a></li>
<li><a href="#org7d1e185">2.2. X86-64</a></li>
<li><a href="#org4f020a8">2.3. ARM32</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
在X86、X86-64平台上协程切换已得到实现的情况下，本文打算在ARM32、ARM64平台上实现同样的功能。在文尾还将介绍一种在已知机器指令的情况下如何获得栈大小的方法。
</p>

<div id="outline-container-org8a16955" class="outline-2">
<h2 id="org8a16955"><span class="section-number-2">1</span> 协程概念</h2>
<div class="outline-text-2" id="text-1">
<p>
进程是资源分配的基本单位，这些资源包括内存空间，文件表，外部设备等，而线程是CPU调度的基本单位。
</p>

<p>
协程是一种用户态的轻量级线程，协程的调度完全由用户控制。协程拥有自己的上下文和栈。协程调度切换时，将寄存器上下文和栈保存到其它地方，在切回来的时候，恢复先前保存的寄存器上下文和栈，
直接操作栈则基本没有内核切换的开销，所以上下文切换用时很少。注意本文在进行这些切换操作时并不涉及段的变化。
</p>

<p>
协程切换是用户空间的事，通过避免通常的切换陷入内核而带来的时间开销，这种切换较传统的上下文切换具有较高的效率。
</p>
</div>
</div>

<div id="outline-container-orga5b9f46" class="outline-2">
<h2 id="orga5b9f46"><span class="section-number-2">2</span> 架构介绍</h2>
<div class="outline-text-2" id="text-2">
<p>
本节将对X86、X86-64、ARM32、ARM64几种平台逐一进行介绍。当然完全的介绍一种体系结构超出了本文的范围，如果读者对此有兴趣，请参考相应官方手册。我仅关心之于我的目的所需要的体系结构的背景知识。这些背景知识包括寄存器介绍，调用惯例，常用指令。
</p>

<p>
寄存器包括通用寄存器和特殊寄存器，一般架构层面会规定出哪些寄存器是特殊的，另一方面，编译器也会说明一些通用寄存器来作为特别的目的。在操作这些特殊寄存器时要特别注意。
</p>

<p>
调用惯例作出了调用者（caller）和被调用者（callee）之间的一系列约定，这些约定包括参数如何传递，哪些寄存器被调用者可以覆盖，被调用者的局部变量应存于何处，结果应如何返回等。之于协程切换的目的，仅需关心参数如何传递并且只有一个参数的情况。
</p>

<p>
本文所涉及的四个平台常用指令都大同小异，下文具体到某个平台时再作详细介绍。
</p>

<p>
CPU架构经常的被分为复杂指令集（<a href="https://en.wikipedia.org/wiki/Complex_instruction_set_computer">CISC</a>）与精简指令集（<a href="https://en.wikipedia.org/wiki/Reduced_instruction_set_computer">RISC</a>）。常见的复杂指令集体系结构包括X86、
X86-64。常见的精简指令集包括ARM系列。二者在设计指令集时是完全相反的思路，CISC希望能在一个时钟周期内完成更多的事情，而RISC希望做更少的事情。这样CISC的指令集会较复杂，硬件电路设计会变得很复杂，但对于汇编程序编写较容易，而RISC具有相反的特点。在后文的实现一节我们会看到这些不同的指令集设计哲学是如何影响到我们的汇编程序编写。网上有许多关于这二者设计思想有意思的讨论，可Google"cisc vs risc"。
</p>

<p>
以下针对体系结构的介绍仅涉及我们所需要的体系结构知识，其所述理论仅是相应体系结构的一个子集。
</p>
</div>
<div id="outline-container-org7088211" class="outline-3">
<h3 id="org7088211"><span class="section-number-3">2.1</span> X86</h3>
<div class="outline-text-3" id="text-2-1">
<p>
本文所指X86具体为Intel 8086系列，这些CPU拥有32位字宽。
</p>
<ul class="org-ul">
<li>寄存器：包括八个通用寄存器eax、ebx、ecx、edx、esi、edi、ebp、esp。一个特殊寄存器eip用来指向当前所要运行的指令。通常编译器会赋予某些通用寄存器以特殊的用途，但体系结构层面并未如此强制要求，这一点下面的其它体系结类似。这些由编译器指明的特殊寄存器的常见用途包括：
<ul class="org-ul">
<li>esp：栈指针，指示栈顶在何处。</li>
<li>ebp：指示栈基址。</li>
</ul></li>
<li>调用惯例：参数被压栈。</li>
<li>常用指令：
<ul class="org-ul">
<li>movl：在内存与寄存器或寄存器与寄存器之间移动数据。</li>
<li>pushl：将内存或某个寄存器的内容压栈。</li>
<li>ret：返回调用者。</li>
<li>leal：将操作数所指地址而非内容加载到寄存器或内存地址中。</li>
<li>subl：将两个操作数做减法。</li>
<li>jmp：无条件跳转。</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org7d1e185" class="outline-3">
<h3 id="org7d1e185"><span class="section-number-3">2.2</span> X86-64</h3>
<div class="outline-text-3" id="text-2-2">
<p>
X86-64架构时X86架构的64位版，此架构具有64位机器字宽。
</p>
<ul class="org-ul">
<li>寄存器：包括16个通用寄存器rax、rbx、rcx、rdx、rsi、rdi、rbp、rsp、r8、r9、r10、r11、r12、r13、
r14、r15。一个特殊寄存器rip用来指向当前所要运行的指令。编译器赋予的特别用途的寄存器包括：
<ul class="org-ul">
<li>rsp：栈指针，指示栈顶在何处。</li>
<li>rbp：指示栈基址。</li>
</ul></li>
<li>调用惯例：第一个参数被传往rdi寄存器。</li>
<li>常用指令：
与X86类似，只是后缀l变为q，代表64位，而l代表32位。</li>
</ul>
</div>
</div>

<div id="outline-container-org4f020a8" class="outline-3">
<h3 id="org4f020a8"><span class="section-number-3">2.3</span> ARM32</h3>
<div class="outline-text-3" id="text-2-3">
<p>
此架构是ARM的32位版，ARM V7及以前的版本是为32位。
</p>
<ul class="org-ul">
<li>寄存器：包括r0-r10共计11个通用寄存器以及以下的特殊寄存器，括号内为其别名：
<ul class="org-ul">
<li>r11(fp)：栈基址寄存器。</li>
<li>r12：存储系统调用的号码。</li>
<li>r13(sp)：指示栈顶。</li>
<li>r14(lr)：存储返回地址。</li>
<li>r15(pc)：程序计数器，指示当前运行的指令。</li>
<li><p>
下面是一个关于X86和ARM寄存器的对应表格。
</p>
<table border="2" rules="all">


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">ARM</th>
<th scope="col" class="org-left">作用</th>
<th scope="col" class="org-left">x86</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">r0</td>
<td class="org-left">通用寄存器</td>
<td class="org-left">eax</td>
</tr>

<tr>
<td class="org-left">r1-r5</td>
<td class="org-left">通用寄存器</td>
<td class="org-left">ebx, ecx, edx, esi, edi</td>
</tr>

<tr>
<td class="org-left">r6-r10</td>
<td class="org-left">通用寄存器</td>
<td class="org-left">无</td>
</tr>

<tr>
<td class="org-left">r11(fp)</td>
<td class="org-left">栈基址</td>
<td class="org-left">ebp</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table></li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Cauchy</p>
<p class="date">Created: 2019-03-12 Tue 15:42</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
